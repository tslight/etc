#+TITLE: Eight Megabytes And Constantly Swapping
#+PROPERTY: header-args: emacs-lisp :lexical t
#+PROPERTY: header-args+ :cache yes :comments yes :mkdirp yes :results silent
#+PROPERTY: header-args+ :tangle (expand-file-name "init.el" user-emacs-directory)
#+PROPERTY: header-args+ :tangle-mode (identity #o644)

A lightweight, [[https://en.wikipedia.org/wiki/Literate_programming][literate]] *Emacs 29+ ONLY* configuration.

To install, open this file in *Emacs 29+* & evaluate the code block below by
placing the cursor in between the =#+begin_src= & =#+end_src= lines and
pressing =C-c C-c=.

#+begin_src emacs-lisp :tangle no
  (org-babel-tangle) (load (expand-file-name "init.el" user-emacs-directory))
#+end_src

This will "tangle" all the code blocks below into =~/.emacs.d/init.el= and then
compile & evaluate it.

#+begin_src emacs-lisp :comments no
  ;; -*- lexical-binding: t; -*-
#+end_src

* EMACS

#+begin_src emacs-lisp
  (use-package emacs
    :init
    (column-number-mode)
    (display-battery-mode)
    (display-time)
    (electric-pair-mode)
    (global-subword-mode)
    (load-theme 'modus-vivendi)
    (when (not (eq system-type 'darwin)) (menu-bar-mode -1))
    (save-place-mode)
    (savehist-mode)
    (scroll-bar-mode -1)
    (set-frame-font "JetBrainsMono Nerd Font 13" nil t)
    (tool-bar-mode -1)
    (tooltip-mode -1)
    :custom
    (auto-save-visited-mode t)
    (backup-directory-alist '(("." . (concat user-emacs-directory "backups"))))
    (completion-styles '(basic substring initials flex))
    (custom-file (expand-file-name "custom.el" user-emacs-directory))
    (disabled-command-function nil)
    (display-time-default-load-average 'nil)
    (display-time-format "%H:%M %a %d/%m")
    (fill-column 79)
    (find-program "fd")
    (grep-program "rg")
    (inhibit-startup-screen t)
    (mac-command-modifier 'control)
    (mac-control-modifier 'super)
    (package-archives
     '(("gnu" . "https://elpa.gnu.org/packages/")
       ("melpa" . "https://melpa.org/packages/")
       ("nongnu" . "https://elpa.nongnu.org/nongnu/")))
    (savehist-additional-variables '(compile-command kill-ring register-alist))
    (use-package-always-defer t)
    (use-package-enable-imenu-support t)
    (use-short-answers t)
    :bind
    ("C-!" . async-shell-command)
    ("C-&" . async-shell-command)
    ("C-<" . beginning-of-buffer)
    ("C->" . end-of-buffer)
    ("C-}" . forward-paragraph)
    ("C-{" . backward-paragraph)
    ("C-c i" . imenu)
    ("C-c f r" . rename-visited-file)
    ("C-;" . comment-line)
    ("C-M-;" . comment-box)
    ("C-s-f" . toggle-frame-fullscreen)
    ("C-z" . zap-up-to-char)
    ("C-c k" . (lambda () (interactive) (kill-buffer (current-buffer))))
    ("C-c m" . compile)
    ("M-m". woman))
#+end_src

* MY/DEFUNS

#+begin_src emacs-lisp
  (defun my/last-buffer ()
    "Switch back and forth between two buffers easily."
    (interactive)
    (switch-to-buffer (other-buffer (current-buffer) 1)))
  (keymap-global-set "C-c b" 'my/last-buffer)

  (defun my/indent-buffer ()
    "Indent the contents of a buffer."
    (interactive)
    (indent-region (point-min) (point-max)))
  (keymap-global-set "M-i" 'my/indent-buffer)

  (defun my/delete-this-file ()
    "Delete the current file, and kill the buffer."
    (interactive)
    (or (buffer-file-name) (error "No file is currently being edited"))
    (when (yes-or-no-p (format "Really delete '%s'?"
			     (file-name-nondirectory buffer-file-name)))
      (delete-file (buffer-file-name) t)
      (kill-this-buffer)))
  (keymap-global-set "C-c f d" 'my/delete-this-file)

  (defun my/buffer-kill-ring-save (file)
    "Copy a file's contents to the clipboard."
    (interactive "f")
    (with-current-buffer (find-file-noselect file)
      (kill-new (buffer-substring-no-properties (point-min) (point-max))))
    (message "Saved contents of %s to the kill ring" file))
  (keymap-global-set "C-c M-w" 'my/buffer-kill-ring-save)

  (defun my/fill-or-unfill ()
    "Like `fill-paragraph', but unfill if used twice."
    (interactive)
    (let ((fill-column
	 (if (eq last-command 'ts-fill-or-unfill)
	     (progn (setq this-command nil)
		    (point-max))
	   fill-column)))
      (call-interactively #'fill-paragraph)))
  (keymap-global-set "M-q" 'my/fill-or-unfill)
#+end_src

* DIRED

#+begin_src emacs-lisp
  (use-package dired
    :custom
    (delete-by-moving-to-trash t)
    :config
    (defun my/dired-up-directory ()
      (interactive)
      (find-alternate-file ".."))
    :bind (:map dired-mode-map
		("b" . my/dired-up-directory)
		("f" . 'dired-find-alternate-file)))
#+end_src

* EWW

#+begin_src emacs-lisp
  (use-package eww
    :custom (eww-search-prefix "https://lite.duckduckgo.com/lite/?q=")
    :bind ("C-c w" . eww))
#+end_src

* ICOMPLETE

#+begin_src emacs-lisp
  (use-package icomplete
    :custom
    (fido-vertical-mode t)
    (icomplete-compute-delay 0)
    :bind (:map icomplete-fido-mode-map
	      ("<tab>" . icomplete-forward-completions)
	      ("<backtab>" . icomplete-backward-completions)
	      ("M-j" . exit-minibuffer)))
#+end_src

* LINE NUMBERS

#+begin_src emacs-lisp
  (use-package display-line-numbers
    :custom
    (display-line-numbers-type 'relative)
    :hook
    (prog-mode . display-line-numbers-mode)
    (sh-script-mode . display-line-numbers-mode))
#+end_src

* MISC

#+begin_src emacs-lisp
  (use-package recentf :bind ("C-c r" . recentf))
  (use-package which-key :config (which-key-mode))
  (use-package whitespace :hook (before-save . whitespace-cleanup))
  (use-package eglot :hook (prog-mode . eglot-ensure))
#+end_src

* ORG

#+begin_src emacs-lisp
  (use-package org
    :custom
    (org-startup-folded t) ; start in overview mode
    (org-goto-interface 'outline-path-completionp)
    (org-outline-path-complete-in-steps nil)
    (org-use-speed-commands t)
    (org-babel-confirm-evaluate nil)
    :config
    ;; stops electric pair from closing > when trying to spawn a src
    ;; block
    (modify-syntax-entry ?< "." org-mode-syntax-table)
    (add-to-list 'org-modules 'org-tempo)
    (setq org-structure-template-alist
	(append org-structure-template-alist
		'(("cl" . "src common-lisp")
		  ("el" . "src emacs-lisp")
		  ("go" . "src go")
		  ("ja" . "src java")
		  ("js" . "src javascript")
		  ("kr" . "src c")
		  ("nx" . "src nix")
		  ("py" . "src python")
		  ("sh" . "src shell")
		  ("sq" . "src sql")
		  ("tx" . "src text"))))
    (defun my/org-babel-tangle-on-save ()
      (when (string-equal (file-name-directory buffer-file-name)
			(concat (getenv "HOME") "/etc/"))
	(org-babel-tangle)))
    (defun my/compile-and-load ()
      (interactive)
      (when (string-match "emacs" (buffer-file-name (current-buffer)))
	(byte-compile-file (buffer-file-name (current-buffer)))
	(load (buffer-file-name (current-buffer)))))
    :bind (:map org-mode-map ("C-c i" . org-goto))
    :hook
    (org-mode . auto-fill-mode)
    (after-save . my/org-babel-tangle-on-save)
    (org-babel-post-tangle . my/compile-and-load))
#+end_src

* OUTLINE

#+begin_src emacs-lisp
  (use-package outline
    :custom
    (outline-minor-mode-cycle t)
    :hook
    (emacs-lisp-mode . outline-minor-mode))
#+end_src

* SHELL SCRIPT

#+begin_src emacs-lisp
  (use-package sh-script
    :hook
    (after-save . executable-make-buffer-file-executable-if-script-p))
#+end_src

* TREESIT

https://www.masteringemacs.org/article/how-to-get-started-tree-sitter

#+begin_src emacs-lisp
  (use-package treesit
    :custom
    (major-mode-remap-alist
     '((yaml-mode . yaml-ts-mode)
       (bash-mode . bash-ts-mode)
       (js2-mode . js-ts-mode)
       (go-mode . go-ts-mode)
       (typescript-mode . typescript-ts-mode)
       (json-mode . json-ts-mode)
       (css-mode . css-ts-mode)
       (python-mode . python-ts-mode))))
#+end_src

Bulk install all the grammars as a one of task, so don't tangle!

#+begin_src emacs-lisp :tangle no
  (setq treesit-language-source-alist
   '((bash "https://github.com/tree-sitter/tree-sitter-bash")
     (cmake "https://github.com/uyha/tree-sitter-cmake")
     (css "https://github.com/tree-sitter/tree-sitter-css")
     (elisp "https://github.com/Wilfred/tree-sitter-elisp")
     (go "https://github.com/tree-sitter/tree-sitter-go")
     (html "https://github.com/tree-sitter/tree-sitter-html")
     (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
     (json "https://github.com/tree-sitter/tree-sitter-json")
     (make "https://github.com/alemuller/tree-sitter-make")
     (markdown "https://github.com/ikatyang/tree-sitter-markdown")
     (nix "https://github.com/nix-community/tree-sitter-nix")
     (python "https://github.com/tree-sitter/tree-sitter-python")
     (toml "https://github.com/tree-sitter/tree-sitter-toml")
     (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
     (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
     (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  (mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist))
#+end_src

* 3RD PARTY

#+begin_src emacs-lisp
  (use-package ace-window :ensure
    :bind*
    ("C-x o" . ace-window)
    ("C-c o" . ace-delete-window)
    :config (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)))
  (use-package copilot :ensure)
  (use-package copilot-chat :ensure :bind ("C-c c" . copilot-chat))
  (use-package corfu :ensure
    :custom
    (corfu-cycle t)
    (corfu-auto t)
    :hook (prog-mode . corfu-mode))
  (use-package default-text-scale :ensure :config (default-text-scale-mode))
  (use-package exec-path-from-shell :ensure
    :hook (after-init . exec-path-from-shell-initialize))
  (use-package git-timemachine :ensure)
  (use-package hungry-delete :ensure :config (global-hungry-delete-mode))
  (use-package kdl-mode :ensure) ; for niri config
  (use-package magit :ensure :bind* ("C-x g" . magit-status))
  (use-package magit-repos
    :bind* ("C-c g" . magit-list-repositories)
    :custom
    (magit-repository-directories `(("~" . 2)))
    (magit-repolist-columns
     '(("Flag" 5 magit-repolist-column-flags ((:right-align t) nil))
	   ("Name" 20 magit-repolist-column-ident nil)
	   ("Branch" 10 magit-repolist-column-branch nil)
	   ("Pull" 5 magit-repolist-column-unpulled-from-upstream ((:right-align t) nil))
	   ("Push" 5 magit-repolist-column-unpushed-to-upstream ((:right-align t) nil))
	   ("Path" 99 magit-repolist-column-path nil))))
  (use-package marginalia :ensure :init (marginalia-mode))
  (use-package markdown-ts-mode :ensure)
  (use-package nix-ts-mode :ensure)
  (use-package vterm :ensure :bind* ("C-c t" . vterm))
  (use-package vundo :ensure :bind* ("C-c u" . vundo))
#+end_src
