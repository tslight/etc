#+TITLE: BEASTIE BITS
#+PROPERTY: header-args :cache yes
#+PROPERTY: header-args+ :mkdirp yes
#+PROPERTY: header-args+ :results silent
#+PROPERTY: header-args+ :padline no
* BOOT/LOADER
#+begin_src conf
efi_max_resolution="1366x768"
loader_gfx="NO" # prevent fancy box rendering
loader_logo="beastie" # prevent fancy logo
autoboot_delay="5"
aesni_load="YES"
geom_eli_load="YES"
kern.geom.label.disk_ident.enable="0"
kern.geom.label.gptid.enable="0"
zfs_load="YES"
compat.linuxkpi.i915_disable_power_well="0"
#+end_src
* BUGS/QUIRKS
** INTEL SOUND WEIRDNESS

https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229190

If seeing a lot of this in the =dmesg=:

#+begin_src
hdac0: Unexpected unsolicited response from address 0: 00000000
#+end_src

Try :

#+begin_src
compat.linuxkpi.i915_disable_power_well="0"
#+end_src

In =/boot/loader.conf=
** MACBOOK FUNCTION KEY HACKING

https://github.com/freebsd/freebsd-src/pull/1998

*** Minimal fix
#+begin_src diff
--- /usr/src/sys/dev/hid/hkbd.c.orig    2026-01-28 18:56:26.052780000 +0000
+++ /usr/src/sys/dev/hid/hkbd.c 2026-01-30 20:41:14.865055000 +0000
@@ -619,6 +619,18 @@
	case 0x4f: return 0x4d; /* RIGHT ARROW -> END */
	case 0x52: return 0x4b; /* UP ARROW -> PGUP */
	case 0x51: return 0x4e; /* DOWN ARROW -> PGDN */
+       case 0x3a: return 0xc0; /* F1 -> BRIGHTNESS DOWN */
+       case 0x3b: return 0xc1; /* F2 -> BRIGHTNESS UP */
+       case 0x3c: return 0xc2; /* F3 -> SCALE (MISSION CTRL)*/
+       case 0x3d: return 0xc3; /* F4 -> DASHBOARD (LAUNCHPAD) */
+       case 0x3e: return 0xc4; /* F5 -> KBD BACKLIGHT DOWN */
+       case 0x3f: return 0xc5; /* F6 -> KBD BACKLIGHT UP */
+       case 0x40: return 0xEA; /* F7 -> MEDIA PREV */
+       case 0x41: return 0xE8; /* F8 -> PLAY/PAUSE */
+       case 0x42: return 0xEB; /* F9 -> MEDIA NEXT */
+       case 0x43: return 0xEF; /* F10 -> MUTE */
+       case 0x44: return 0xEE; /* F11 -> VOLUME DOWN */
+       case 0x45: return 0xED; /* F12 -> VOLUME UP */
	default: return keycode;
	}
 }
@@ -793,10 +805,15 @@
			    HKBD_FLAG_APPLE_SWAP;
		DPRINTFN(1, "Found Apple eject-key\n");
	}
-       if (hidbus_locate(ptr, len,
+
+       if ((hidbus_locate(ptr, len,
+                          HID_USAGE2(0x00FF, 0x0003),
+                          hid_input, tlc_index, 0, &sc->sc_loc_apple_fn, &flags,
+                          &sc->sc_id_apple_fn, NULL)) ||
+           (hidbus_locate(ptr, len,
	    HID_USAGE2(0xFFFF, 0x0003),
	    hid_input, tlc_index, 0, &sc->sc_loc_apple_fn, &flags,
-           &sc->sc_id_apple_fn, NULL)) {
+                          &sc->sc_id_apple_fn, NULL))) {
		if (flags & HIO_VARIABLE)
			sc->sc_flags |= HKBD_FLAG_APPLE_FN;
		DPRINTFN(1, "Found Apple FN-key\n");
#+end_src
*** Get Fn by itself registering v1
#+begin_src diff
--- /usr/src/sys/dev/hid/hkbd.c.orig    2026-01-28 18:56:26.052780000 +0000
+++ /usr/src/sys/dev/hid/hkbd.c 2026-01-30 08:17:50.271155000 +0000
@@ -122,6 +123,8 @@

 #define        MOD_EJECT       0x01
 #define        MOD_FN          0x02
+
+#define APPLE_FN_KEYCODE 0xff

 #define MOD_MIN     0xe0
 #define MOD_MAX     0xe7
@@ -291,7 +294,7 @@
	29, 42, 56, 105, 90, 54, 93, 106,       /* E0 - E7 */
	NN, NN, NN, NN, NN, NN, NN, NN, /* E8 - EF */
	NN, NN, NN, NN, NN, NN, NN, NN, /* F0 - F7 */
-       NN, NN, NN, NN, NN, NN, NN, NN, /* F8 - FF */
+       NN, NN, NN, NN, NN, NN, NN, 255,        /* F8 - FF */
 };

 static const uint8_t hkbd_boot_desc[] = { HID_KBD_BOOTPROTO_DESCR() };
@@ -516,6 +519,7 @@
			continue;
		hkbd_put_key(sc, key | KEY_PRESS);

+               if (key != APPLE_FN_KEYCODE) { // don't let fn repeat
		sc->sc_co_basetime = sbinuptime();
		sc->sc_delay = sc->sc_kbd.kb_delay1;
		hkbd_start_timer(sc);
@@ -524,6 +528,7 @@
		sc->sc_repeat_time = now + sc->sc_kbd.kb_delay1;
		sc->sc_repeat_key = key;
	}
+       }

	/* synchronize old data with new data */
	memcpy(sc->sc_odata0, sc->sc_ndata0, bitstr_size(HKBD_NKEYCODE));
@@ -613,12 +618,25 @@
 hkbd_apple_fn(uint32_t keycode)
 {
	switch (keycode) {
+       /* check evdev_usb_scancodes[] for location */
	case 0x28: return 0x49; /* RETURN -> INSERT */
	case 0x2a: return 0x4c; /* BACKSPACE -> DEL */
	case 0x50: return 0x4a; /* LEFT ARROW -> HOME */
	case 0x4f: return 0x4d; /* RIGHT ARROW -> END */
	case 0x52: return 0x4b; /* UP ARROW -> PGUP */
	case 0x51: return 0x4e; /* DOWN ARROW -> PGDN */
+       case 0x3a: return 0xc0; /* F1 -> BRIGHTNESS DOWN */
+       case 0x3b: return 0xc1; /* F2 -> BRIGHTNESS UP */
+       case 0x3c: return 0xc2; /* F3 -> SCALE (MISSION CTRL)*/
+       case 0x3d: return 0xc3; /* F4 -> DASHBOARD (LAUNCHPAD) */
+       case 0x3e: return 0xc4; /* F5 -> KBD BACKLIGHT DOWN */
+       case 0x3f: return 0xc5; /* F6 -> KBD BACKLIGHT UP */
+       case 0x40: return 0xEA; /* F7 -> MEDIA PREV */
+       case 0x41: return 0xE8; /* F8 -> PLAY/PAUSE */
+       case 0x42: return 0xEB; /* F9 -> MEDIA NEXT */
+       case 0x43: return 0xEF; /* F10 -> MUTE */
+       case 0x44: return 0xEE; /* F11 -> VOLUME DOWN */
+       case 0x45: return 0xED; /* F12 -> VOLUME UP */
	default: return keycode;
	}
 }
@@ -684,8 +702,20 @@
	if ((sc->sc_flags & HKBD_FLAG_APPLE_FN) &&
	    (id == sc->sc_id_apple_fn)) {
		if (hid_get_data(buf, len, &sc->sc_loc_apple_fn))
+                       modifiers |= MOD_FN;
+       }
+
+       /* Check for Apple Fn key in Consumer Control (report ID 1, byte 8) */
+       if (sc->sc_kbd_id != 0 && len >= 9 && id == 1) {
+               if (buf[8] == 0x02) {
+                       DPRINTF("FN key from Consumer Control pressed!\n");
+                       bit_set(sc->sc_ndata, APPLE_FN_KEYCODE);
			modifiers |= MOD_FN;
+               } else if (buf[8] == 0x00 && bit_test(sc->sc_odata, APPLE_FN_KEYCODE)) {
+                       DPRINTF("FN key from Consumer Control released!\n");
+                       bit_clear(sc->sc_ndata, APPLE_FN_KEYCODE);
	}
+       }

	bit_foreach(sc->sc_loc_key_valid, HKBD_NKEYCODE, i) {
		if (id != sc->sc_id_loc_key[i]) {
@@ -1934,6 +1964,8 @@
		0x5c,   /* Keyboard Intl' 6 (Keypad ,) (For PC-9821 layout) */
		0x71,   /* Apple Keyboard JIS (Kana) */
		0x72,   /* Apple Keyboard JIS (Eisu) */
+               /* Misc 200 - 255 */
+               0xff,   /* Apple Fn key */
	};

	if ((code >= 89) && (code < (int)(89 + nitems(scan)))) {
#+end_src

#+begin_src diff
--- /home/anon/src/freebsd-src/sys/dev/evdev/evdev_utils.c      2026-01-28 23:42:32.891340000 +0000
+++ /usr/src/sys/dev/evdev/evdev_utils.c        2026-01-30 07:57:30.845772000 +0000
@@ -92,8 +92,8 @@
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
	/* 0xc0 - 0xdf */
-       NONE,           NONE,           NONE,           NONE,
-       NONE,           NONE,           NONE,           NONE,
+       KEY_BRIGHTNESSDOWN, KEY_BRIGHTNESSUP, KEY_SCALE, KEY_DASHBOARD,
+       KEY_KBDILLUMDOWN, KEY_KBDILLUMUP, NONE,         NONE,
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
@@ -108,7 +108,7 @@
	KEY_WWW,        KEY_BACK,       KEY_FORWARD,    KEY_STOP,
	KEY_FIND,       KEY_SCROLLUP,   KEY_SCROLLDOWN, KEY_EDIT,
	KEY_SLEEP,      KEY_COFFEE,     KEY_REFRESH,    KEY_CALC,
-       NONE,           NONE,           NONE,           NONE,
+       NONE,           NONE,           NONE,           KEY_WAKEUP,

 };
#+end_src
*** Final Fn key fixes
#+begin_src diff
--- /usr/src/sys/dev/hid/hkbd.c.orig    2026-01-28 18:56:26.052780000 +0000
+++ /usr/src/sys/dev/hid/hkbd.c 2026-01-31 08:33:31.427321000 +0000
@@ -97,6 +97,7 @@
 static int hkbd_debug = 0;
 #endif
 static int hkbd_no_leds = 0;
+static int hkbd_fn_mode = 0;

 static SYSCTL_NODE(_hw_hid, OID_AUTO, hkbd, CTLFLAG_RW, 0, "USB keyboard");
 #ifdef HID_DEBUG
@@ -105,6 +106,8 @@
 #endif
 SYSCTL_INT(_hw_hid_hkbd, OID_AUTO, no_leds, CTLFLAG_RWTUN,
     &hkbd_no_leds, 0, "Disables setting of keyboard leds");
+SYSCTL_INT(_hw_hid_hkbd, OID_AUTO, fn_mode, CTLFLAG_RWTUN,
+          &hkbd_fn_mode, 0, "0 = Fn + F1..12 -> media, 1 = F1..F12 -> media");

 #define        INPUT_EPOCH     global_epoch_preempt

@@ -291,7 +294,7 @@
	29, 42, 56, 105, 90, 54, 93, 106,       /* E0 - E7 */
	NN, NN, NN, NN, NN, NN, NN, NN, /* E8 - EF */
	NN, NN, NN, NN, NN, NN, NN, NN, /* F0 - F7 */
-       NN, NN, NN, NN, NN, NN, NN, NN, /* F8 - FF */
+       NN, NN, NN, NN, NN, NN, NN, 255, /* F8 - FF */
 };

 static const uint8_t hkbd_boot_desc[] = { HID_KBD_BOOTPROTO_DESCR() };
@@ -619,6 +622,26 @@
	case 0x4f: return 0x4d; /* RIGHT ARROW -> END */
	case 0x52: return 0x4b; /* UP ARROW -> PGUP */
	case 0x51: return 0x4e; /* DOWN ARROW -> PGDN */
+       default: return keycode;
+       }
+}
+
+static uint32_t
+hkbd_apple_fn_media(uint32_t keycode)
+{
+       switch (keycode) {
+       case 0x3a: return 0xc0; /* F1 -> BRIGHTNESS DOWN */
+       case 0x3b: return 0xc1; /* F2 -> BRIGHTNESS UP */
+       case 0x3c: return 0xc2; /* F3 -> SCALE (MISSION CTRL)*/
+       case 0x3d: return 0xc3; /* F4 -> DASHBOARD (LAUNCHPAD) */
+       case 0x3e: return 0xc4; /* F5 -> KBD BACKLIGHT DOWN */
+       case 0x3f: return 0xc5; /* F6 -> KBD BACKLIGHT UP */
+       case 0x40: return 0xEA; /* F7 -> MEDIA PREV */
+       case 0x41: return 0xE8; /* F8 -> PLAY/PAUSE */
+       case 0x42: return 0xEB; /* F9 -> MEDIA NEXT */
+       case 0x43: return 0xEF; /* F10 -> MUTE */
+       case 0x44: return 0xEE; /* F11 -> VOLUME DOWN */
+       case 0x45: return 0xED; /* F12 -> VOLUME UP */
	default: return keycode;
	}
 }
@@ -683,9 +706,17 @@
	}
	if ((sc->sc_flags & HKBD_FLAG_APPLE_FN) &&
	    (id == sc->sc_id_apple_fn)) {
-               if (hid_get_data(buf, len, &sc->sc_loc_apple_fn))
+               if (hid_get_data(buf, len, &sc->sc_loc_apple_fn)) {
+                       /* Will show up as whatever is set to the last item in
+                        * evdev_usb_scancodes[] from evdev-utils.c. Since
+                        * KEY_FN doesn't make it through to xkb, KEY_WAKEUP is
+                        * a good alternative. */
+                       bit_set(sc->sc_ndata, 0xff);
			modifiers |= MOD_FN;
+               } else {
+                       bit_clear(sc->sc_ndata, 0xff);
	}
+       }

	bit_foreach(sc->sc_loc_key_valid, HKBD_NKEYCODE, i) {
		if (id != sc->sc_id_loc_key[i]) {
@@ -710,6 +741,8 @@
				}
				if (modifiers & MOD_FN)
					key = hkbd_apple_fn(key);
+                               if ((modifiers & MOD_FN) != hkbd_fn_mode)
+                                       key = hkbd_apple_fn_media(key);
				if (sc->sc_flags & HKBD_FLAG_APPLE_SWAP)
					key = hkbd_apple_swap(key);
				if (key == KEY_NONE || key >= HKBD_NKEYCODE)
@@ -723,6 +756,8 @@

			if (modifiers & MOD_FN)
				key = hkbd_apple_fn(key);
+                       if ((modifiers & MOD_FN) != hkbd_fn_mode)
+                               key = hkbd_apple_fn_media(key);
			if (sc->sc_flags & HKBD_FLAG_APPLE_SWAP)
				key = hkbd_apple_swap(key);
			if (key == KEY_NONE || key == KEY_ERROR || key >= HKBD_NKEYCODE)
@@ -793,10 +828,15 @@
			    HKBD_FLAG_APPLE_SWAP;
		DPRINTFN(1, "Found Apple eject-key\n");
	}
-       if (hidbus_locate(ptr, len,
+
+       if ((hidbus_locate(ptr, len,
+                          HID_USAGE2(0x00FF, 0x0003),
+                          hid_input, tlc_index, 0, &sc->sc_loc_apple_fn, &flags,
+                          &sc->sc_id_apple_fn, NULL)) ||
+           (hidbus_locate(ptr, len,
	    HID_USAGE2(0xFFFF, 0x0003),
	    hid_input, tlc_index, 0, &sc->sc_loc_apple_fn, &flags,
-           &sc->sc_id_apple_fn, NULL)) {
+                          &sc->sc_id_apple_fn, NULL))) {
		if (flags & HIO_VARIABLE)
			sc->sc_flags |= HKBD_FLAG_APPLE_FN;
		DPRINTFN(1, "Found Apple FN-key\n");
#+end_src

#+begin_src diff
--- /home/anon/src/freebsd-src/sys/dev/evdev/evdev_utils.c      2026-01-28 23:42:32.891340000 +0000
+++ /usr/src/sys/dev/evdev/evdev_utils.c        2026-01-30 07:57:30.845772000 +0000
@@ -92,8 +92,8 @@
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
	/* 0xc0 - 0xdf */
-       NONE,           NONE,           NONE,           NONE,
-       NONE,           NONE,           NONE,           NONE,
+       KEY_BRIGHTNESSDOWN, KEY_BRIGHTNESSUP, KEY_SCALE, KEY_DASHBOARD,
+       KEY_KBDILLUMDOWN, KEY_KBDILLUMUP, NONE,         NONE,
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
	NONE,           NONE,           NONE,           NONE,
@@ -108,7 +108,7 @@
	KEY_WWW,        KEY_BACK,       KEY_FORWARD,    KEY_STOP,
	KEY_FIND,       KEY_SCROLLUP,   KEY_SCROLLDOWN, KEY_EDIT,
	KEY_SLEEP,      KEY_COFFEE,     KEY_REFRESH,    KEY_CALC,
-       NONE,           NONE,           NONE,           NONE,
+       NONE,           NONE,           NONE,           KEY_WAKEUP,

 };
#+end_src
* CRON

#+begin_src cron
SHELL=/bin/sh
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin
\*       *       *       *       *       /usr/local/bin/asmcfan
\*       *       *       *       *       /usr/local/bin/fscksaver
#+end_src

** ASMCFAN

Control the fans depending on temperature, in a Macbook that supports ASMC.

#+begin_src shell :tangle /sudo::/usr/local/bin/asmcfan :tangle-mode o755
  #!/bin/sh
  if ! kldstat | grep -q asmc.ko; then
      if ! kldload asmc; then
	  logger -t asmcfan "ERROR: Failed to load ASMC module."
	  exit 1
      fi
  fi

  TEMP=$(sysctl -n dev.cpu.0.temperature | cut -c 1-2)
  CUR_SPEED=$(sysctl -n dev.asmc.0.fan.0.targetspeed)
  SET_SPEED=0

  if [ "$TEMP" -le 25 ]; then
      SET_SPEED=0
      logger -t asmcfan "${TEMP}°C: ${SET_SPEED}RPM: BRRRRRRR!!!"
  elif [ "$TEMP" -le 30 ]; then
      SET_SPEED=1000
      logger -t asmcfan "${TEMP}°C: ${SET_SPEED}RPM: Getting a tad bit nippy..."
  elif [ "$TEMP" -le 35 ]; then
      SET_SPEED=1500
  elif [ "$TEMP" -le 40 ]; then
      SET_SPEED=2000
  elif [ "$TEMP" -le 45 ]; then
      SET_SPEED=2500
  elif [ "$TEMP" -le 55 ]; then
      SET_SPEED=3000
  elif [ "$TEMP" -le 60 ]; then
      SET_SPEED=3500
  elif [ "$TEMP" -le 65 ]; then
      SET_SPEED=4000
  elif [ "$TEMP" -le 70 ]; then
      SET_SPEED=4500
  elif [ "$TEMP" -le 75 ]; then
      SET_SPEED=5000
  elif [ "$TEMP" -le 80 ]; then
      SET_SPEED=5500
      logger -t asmcfan "${TEMP}°C: ${SET_SPEED}RPM: It's getting HOT in here..."
  elif [ "$TEMP" -le 85 ]; then
      SET_SPEED=6000
      logger -t asmcfan "${TEMP}°C: ${SET_SPEED}RPM: I'm melting..."
  else
      SET_SPEED=6500
      logger -t asmcfan "${TEMP}°C: ${SET_SPEED}RPM: SCORCHIO!!!"
  fi

  if [ "$SET_SPEED" -ne "$CUR_SPEED" ]; then
      sysctl dev.asmc.0.fan.0.maxspeed="$SET_SPEED" > /dev/null
      sysctl dev.asmc.0.fan.0.minspeed="$SET_SPEED" > /dev/null
      if sysctl dev.asmc.0.fan.1 2> /dev/null; then
	  sysctl dev.asmc.0.fan.1.maxspeed="$SET_SPEED" > /dev/null
	  sysctl dev.asmc.0.fan.1.minspeed="$SET_SPEED" > /dev/null
      fi
  fi

  exit 0
#+end_src
** FSCKSAVER

Shutdown when battery is lower than 10% and we're not charging.

#+begin_src shell :tangle /sudo::/usr/local/bin/fscksaver :tangle-mode o755
  #!/bin/sh

  # Get battery life percentage
  battery_life=$(sysctl -n hw.acpi.battery.life)

  # Get AC line status (1 = plugged in, 0 = on battery)
  ac_status=$(sysctl -n hw.acpi.acline)

  # Check if battery is below 5% and not plugged in
  if [ "$battery_life" -lt 5 ] && [ "$ac_status" -eq 0 ]; then
      logger -t fscksaver "$battery_life% & not charging. Shutting down..."
      shutdown -p now
  fi
#+end_src

* GENERAL

https://docs.freebsd.org/en/books/handbook/x11/
https://docs.freebsd.org/en/books/handbook/kernelconfig/
https://www.duskopijetlovic.com/boot/dotfiles/howto/freebsd/config/sysadmin/2025/03/02/new-freebsd-system-setup.html

* HARDWARE
** MACBOOK

https://joshua.hu/FreeBSD-on-MacbookPro-114-A1398
https://freebsd.uw.cz/2025/05/freebsd-and-edimax-n150-wi-fi-usb.html
https://duriansoftware.com/joe/freebsd-installation-notes-for-a-2011-macbook-air
https://itsfoss.gitlab.io/post/configuring-bcm4360-macbook-air-on-freebsd-to-connect-to-wifi/

*** AIR 7,2
**** BIZARRE SOUND PIN/CODEC ISSUE

After much faffing and too-ing and fro-ing to the installer (where bizarrely
the sound pins were configured correctly) - I came up with these hints to make
my sound work.

Stick 'em in =/boot/device.hints= if you want to hear anything...

#+begin_src conf
hint.hdac.1.cad0.nid16.config="as=2 seq=0 device=Headphones conn=Jack ctype=Combo"
hint.hdac.1.cad0.nid17.config="as=15 seq=0 device=Line-out conn=None ctype=Unknown misc=0"
hint.hdac.1.cad0.nid18.config="as=1 seq=0 device=Speaker conn=Fixed loc=Internal misc=1"
hint.hdac.1.cad0.nid19.config="as=15 seq=0 device=Line-out conn=None ctype=Unknown misc=0"
hint.hdac.1.cad0.nid20.config="as=15 seq=0 device=Line-out conn=None ctype=Unknown misc=0"
hint.hdac.1.cad0.nid24.config="as=3 seq=0 device=Mic conn=Jack ctype=Combo"
hint.hdac.1.cad0.nid28.config="as=0 seq=0 device=Mic conn=Fixed ctype=Digital loc=internal misc=1"
hint.hdaa.1.gpio_config="0=set"
#+end_src

*** PRO 8,3

https://wiki.freebsd.org/Graphics/AMD-GPU-Matrix
https://www.reddit.com/r/freebsd/comments/1jhx9y5/kld_list_entries_for_an_apple_macbookpro83_with/

**** Dodgy touchpad

https://forums.freebsd.org/threads/after-upgrading-the-system-touchpad-unresponsive-and-keyboard-key-incorrectly-mapping.100766/

#+begin_src conf
# fix dodgy mbp 8,3 touchpad in 15.0
hidquirk_load="YES"
hw.hid.quirk.0="0x03 0x05ac 0x0253 0 0xffff HQ_HID_IGNORE"
#+end_src

In =/boot/loader.conf= seems to do the trick!

Which I'm pretty sure is all one needs, however, I also did:

#+begin_src conf
hint.ums.0.disabled="1"
hint.atp.0.disabled="1"
hint.bcm5974.0.disabled="1"
#+end_src

In =/boot/device.hints=, and:

#+begin_src conf
moused_enable="YES"
moused_port="/dev/wsp0"
devmatch_blocklist="atp bcm5974 wmt hms ums psm"
#+end_src

In =/etc/rc.conf= ... :-/

**** Suspend

https://bugs.freebsd.org/bugzilla//show_bug.cgi?id=252241
https://forums.freebsd.org/threads/will-we-have-drm-kmod-driver-i915kms-ko-for-14-3-release-i386.100943/
https://forums.macrumors.com/threads/force-2011-macbook-pro-8-2-with-failed-amd-gpu-to-always-use-intel-integrated-gpu-efi-variable-fix.2037591/

On Macbook Pro 8,3 - disable AMD GPU from OSX recovery with:

#+begin_src shell
nvram gpu-power-prefs=%01%00%00%00
nvram fa4ce28d-b62f-4c99-9cc3-6815686e30f9:gpu-power-prefs=%01%00%00%00
#+end_src

After that we should be able to load and use i915kms, prior to that the system
will become unresponsive when i915kms is loaded.

**** ASMC

https://logi.wiki/index.php/SMC_Sensor_Codes
https://github.com/freebsd/freebsd-src/pull/1992

https://forums.freebsd.org/threads/macbook7-1-asmc-support.76497/
https://bugs.freebsd.org/bugzilla//show_bug.cgi?id=272787
https://cgit.freebsd.org/src/tree/sys/dev/asmc/asmc.c?h=main

#+name: /usr/src/sys/dev/asmc/asmc.c.patch
#+begin_src diff
--- ./asmc.c.orig	2026-01-26 20:45:55.675061000 +0000
+++ asmc.c	2026-01-27 14:22:02.389812000 +0000
@@ -256,6 +256,12 @@
	},

	{
+	  "MacBookPro8,3", "Apple SMC MacBook Pro (early 2011, 17-inch)",
+	  ASMC_SMS_FUNCS, ASMC_FAN_FUNCS2, ASMC_LIGHT_FUNCS,
+	  ASMC_MBP83_TEMPS, ASMC_MBP83_TEMPNAMES, ASMC_MBP83_TEMPDESCS
+	},
+
+	{
	  "MacBookPro9,1", "Apple SMC MacBook Pro (mid 2012, 15-inch)",
	  ASMC_SMS_FUNCS_DISABLED, ASMC_FAN_FUNCS, ASMC_LIGHT_FUNCS,
	  ASMC_MBP91_TEMPS, ASMC_MBP91_TEMPNAMES, ASMC_MBP91_TEMPDESCS
#+end_src

#+name: /usr/src/sys/dev/asmc/asmcvar.h.patch
#+begin_src diff
--- ./asmcvar.h.orig	2026-01-26 20:45:55.675873000 +0000
+++ asmcvar.h	2026-01-27 14:26:09.265793000 +0000
@@ -326,6 +326,30 @@
				  "TMBS", "TP0P", "TPCD", "TW0P", "Th1H", \
				  "Th2H", "Tm0P", "Ts0P", "Ts0S" }

+#define ASMC_MBP83_TEMPS	{ "TC0C", "TC0D", "TC0P", "TPCD", "TP0P", \
+				  "TG0D", "TG0P", "Tm0P", "Th1H", "Th2H", \
+				  "TB0T", "TB1T", "TB2T", "Ts0P", "ALSL", \
+				  "VD0R", "VP0R", "VC0C", "ID0R", "IB0R", \
+				  "IC0R", NULL }
+
+#define ASMC_MBP83_TEMPNAMES	{ "cpu_die_digital_core_2", "cpu_0_die_analog", \
+				  "cpu_proximity", "pch_die_digital", "pch_proximity", \
+				  "gpu_die", "gpu_0_proximity", "mlb_proximity", \
+				  "right_fin_stack_proximity", "left_fin_stack_proximity", \
+				  "battery_ts_max", "battery_ts_1", "battery_ts_2", \
+				  "palmrest_proximity", "ambient_light_sensor",
+				  "dc_in_voltage", "pbus_voltage", "cpu_vcore_voltage", \
+				  "dc_in_current", "battery_current", "combined_cores" }
+
+#define ASMC_MBP83_TEMPDESCS	{ "CPU Die Digital Core 2", "CPU 0 Die Analog", \
+				  "CPU Proximity", "PCH Die Digital", "PCH Proximity", \
+				  "GPU Die", "GPU 0 Proximity", "MLB Proximity", \
+				  "Right Fin Stack Proximity", "Left Fin Stack Proximity", \
+				  "Battery TS MAX", "Battery TS 1", "Battery TS 2", \
+				  "Palmrest Proximity", "Ambient Light Sensor", \
+				  "DC In (Voltage)", "PBus (Voltage)", "CPU Vcore (Voltage)", \
+				  "DC In (Current)", "Battery (Current)", "Combined Cores" }
+
 #define ASMC_MBP91_TEMPS	{ "TA0P", "TB0T", "TB1T", "TB2T", "TC0E", \
				  "TC0F", "TC0P", "TC1C", "TC2C", "TC3C", \
				  "TC4C", "TCGC", "TCSA", "TCXC", "TG0D", \
#+end_src

**** BACKLIGHT

https://github.com/tslight/gmuxctl/tree/main/backlight

Despite the fact that we can load =acpi_video= kmod and get some promising new
sysctls, nothing actually changes the backlight, even though they profess to...

On Macbooks with dual GPUs of this vintage, the GMUX chip controls switching
between Integrated/Discrete GPUs and backlight.

For proper backlight on MBP 8,3, someone would need to port the Linux
~apple-gmux~ driver to FreeBSD. The GMUX chip sits at IO port ~0x700~ and
controls backlight via specific register writes.

For the time being, here's some hack C code to achieve what I want:

#+begin_src c
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <machine/cpufunc.h>

#define GMUX_PORT_BRIGHTNESS 0x774

int main(int argc, char *argv[]) {
    int fd;
    uint32_t val;

    fd = open("/dev/io", O_RDWR);
    if (fd < 0) {
	perror("open /dev/io");
	return 1;
    }

    if (argc == 1) {
	/* Read current brightness */
	val = inl(GMUX_PORT_BRIGHTNESS);
	printf("Current brightness: 0x%x (%d%%)\n", val, val * 100 / 0xFFFF);
    } else {
	/* Set brightness (0-100) */
	int pct = atoi(argv[1]);
	if (pct < 0 || pct > 100) {
	    fprintf(stderr, "Value must be 0-100\n");
	    close(fd);
	    return 1;
	}
	val = pct * 0xFFFF / 100;
	outl(GMUX_PORT_BRIGHTNESS, val);
	printf("Set brightness to %d%% (0x%x)\n", pct, val);
    }

    close(fd);
    return 0;
}
#+end_src

For more GMUX HAX take a look at: https://github.com/tslight/gmuxctl

* HOSTNAMES

https://www.youtube.com/watch?v=TgeUniPBQjM&list=WL&index=1

Hostnames: freefall, groundrush, skyrush, thud, treefall

* PACKAGES

#+begin_src sh :results output replace :cache no
  pkg query -e '%a = 0' %o
#+end_src

#+RESULTS:
#+begin_example
base/FreeBSD-kernel-generic
base/FreeBSD-kernel-generic-dbg
base/FreeBSD-set-base
base/FreeBSD-set-lib32
base/FreeBSD-set-minimal
devel/ccls
devel/cmake
ftp/curl
x11-wm/cwm
graphics/drm-kmod
editors/emacs
textproc/en-aspell
misc/freebsd-doc-en
x11/evtest
devel/git
textproc/jq
misc/kbdscan
www/librewolf
devel/libtool
devel/libvterm
multimedia/mpv
ports-mgmt/pkg
accessibility/sct
sysutils/sensors
sysutils/smartmontools
security/sudo
sysutils/tmux
x11/xlibre
x11-drivers/xlibre-xf86-video-intel
www/yt-dlp
shells/zsh
#+end_example

* SUDOERS

#+begin_src con
Defaults insults
Defaults timestamp_timeout = 30
%wheel ALL=(ALL:ALL) ALL
%operator ALL=(ALL) NOPASSWD: /usr/bin/backlight
#+end_src

* VT

Either copy an existing keymap file from =/usr/share/vt/keymaps= or use
=kbdcontrol -d > foo.kbd= to generate a new keymap. Then use the =kbdscan=
package to figure out the scancode for a given key.

Use =kbdcontrol -l /path/to/foo.kbd= to test the new layout and once happy put
it in =/usr/share/vt/keymaps= and run =sysrc keymap=foo.kbd= or add
=keymap=foo.kbd= to =/etc/rc.conf=.

Once everything is working as expected and you've tested with a reboot, add an
entry below, and optionally add =:tangle /sudo::/usr/share/vt/keymaps/foo.kbd=.

** JP EMACS MACBOOK

Make the most of the extra modifier keys on a Korean/Japanese layout

#+begin_src conf :tangle /sudo::/usr/share/vt/keymaps/jp.emacs.macbook.kbd :tangle-mode o444
#                                                         alt
# scan                       cntrl          alt    alt   cntrl lock
# code  base   shift  cntrl  shift  alt    shift  cntrl  shift state
# ------------------------------------------------------------------
  000   nop    nop    nop    nop    nop    nop    nop    nop     O
  001   clock  clock  clock  clock  clock  clock  susp   clock   O
  002   '1'    '!'    nop    nop    '1'    '!'    nop    nop     O
  003   '2'    '@'    nul    nul    '2'    '@'    nul    nul     O
  004   '3'    '#'    nop    nop    '3'    '#'    nop    nop     O
  005   '4'    '$'    nop    nop    '4'    '$'    nop    nop     O
  006   '5'    '%'    '%'    '5'    '5'    '%'    nop    nop     O
  007   '6'    '^'    rs     rs     '6'    '^'    rs     rs      O
  008   '7'    '&'    nop    nop    '7'    '&'    nop    nop     O
  009   '8'    '*'    nop    nop    '8'    '*'    nop    nop     O
  010   '9'    '('    nop    nop    '9'    '('    nop    nop     O
  011   '0'    ')'    nop    nop    '0'    ')'    nop    nop     O
  012   '-'    '_'    us     us     '-'    '_'    us     us      O
  013   '='    '+'    nop    nop    '='    '+'    nop    nop     O
  014   bs     bs     del    del    bs     bs     del    del     O
  015   ht     btab   nop    nop    ht     btab   nop    nop     O
  016   'q'    'Q'    dc1    dc1    'q'    'Q'    dc1    dc1     C
  017   'w'    'W'    etb    etb    'w'    'W'    etb    etb     C
  018   'e'    'E'    enq    enq    'e'    'E'    enq    enq     C
  019   'r'    'R'    dc2    dc2    'r'    'R'    dc2    dc2     C
  020   't'    'T'    dc4    dc4    't'    'T'    dc4    dc4     C
  021   'y'    'Y'    em     em     'y'    'Y'    em     em      C
  022   'u'    'U'    nak    nak    'u'    'U'    nak    nak     C
  023   'i'    'I'    ht     ht     'i'    'I'    ht     ht      C
  024   'o'    'O'    si     si     'o'    'O'    si     si      C
  025   'p'    'P'    dle    dle    'p'    'P'    dle    dle     C
  026   '['    '{'    esc    esc    '['    '{'    esc    esc     O
  027   ']'    '}'    gs     gs     ']'    '}'    gs     gs      O
  028   cr     cr     nl     nl     cr     cr     nl     nl      O
  029   esc    esc    esc    esc    esc    esc    esc    esc     O
  030   'a'    'A'    soh    soh    'a'    'A'    soh    soh     C
  031   's'    'S'    dc3    dc3    's'    'S'    dc3    dc3     C
  032   'd'    'D'    eot    eot    'd'    'D'    eot    eot     C
  033   'f'    'F'    ack    ack    'f'    'F'    ack    ack     C
  034   'g'    'G'    bel    bel    'g'    'G'    bel    bel     C
  035   'h'    'H'    bs     bs     'h'    'H'    bs     bs      C
  036   'j'    'J'    nl     nl     'j'    'J'    nl     nl      C
  037   'k'    'K'    vt     vt     'k'    'K'    vt     vt      C
  038   'l'    'L'    ff     ff     'l'    'L'    ff     ff      C
  039   ';'    ':'    ';'    ':'    ';'    ':'    nop    nop     O
  040   '''    '"'    '''    '"'    '''    '"'    nop    nop     O
  041   '`'    '~'    '`'    '~'    '`'    '~'    nop    nop     O
  042   lshift lshift lshift lshift lshift lshift lshift lshift  O
  043   '\'    '|'    fs     fs     '\'    '|'    fs     fs      O
  044   'z'    'Z'    sub    sub    'z'    'Z'    sub    sub     C
  045   'x'    'X'    can    can    'x'    'X'    can    can     C
  046   'c'    'C'    etx    etx    'c'    'C'    etx    etx     C
  047   'v'    'V'    syn    syn    'v'    'V'    syn    syn     C
  048   'b'    'B'    stx    stx    'b'    'B'    stx    stx     C
  049   'n'    'N'    so     so     'n'    'N'    so     so      C
  050   'm'    'M'    cr     cr     'm'    'M'    cr     cr      C
  051   ','    '<'    nop    nop    ','    '<'    nop    nop     O
  052   '.'    '>'    nop    nop    '.'    '>'    nop    nop     O
  053   '/'    '?'    us     us     '/'    '?'    us     us      O
  054   rshift rshift rshift rshift rshift rshift rshift rshift  O
  055   '*'    '*'    '*'    '*'    '*'    '*'    '*'    '*'     O
  056   lalt   lalt   lalt   lalt   lalt   lalt   lalt   lalt    O
  057   ' '    ' '    nul    nul    ' '    ' '    nul    nul     O
  058   esc    esc    esc    esc    esc    esc    esc    esc     O
  059   fkey01 fkey13 scr01  fkey37 scr01  scr11  scr01  scr11   O
  060   fkey02 fkey14 scr02  fkey38 scr02  scr12  scr02  scr12   O
  061   fkey03 fkey15 scr03  fkey39 scr03  scr13  scr03  scr13   O
  062   fkey04 fkey16 scr04  fkey40 scr04  scr14  scr04  scr14   O
  063   fkey05 fkey17 scr05  fkey41 scr05  scr15  scr05  scr15   O
  064   fkey06 fkey18 scr06  fkey42 scr06  scr16  scr06  scr16   O
  065   fkey07 fkey19 scr07  fkey43 scr07  scr07  scr07  scr07   O
  066   fkey08 fkey20 scr08  fkey44 scr08  scr08  scr08  scr08   O
  067   fkey09 fkey21 scr09  fkey45 scr09  scr09  scr09  scr09   O
  068   fkey10 fkey22 scr10  fkey46 scr10  scr10  scr10  scr10   O
  069   nlock  nlock  nlock  nlock  nlock  nlock  nlock  nlock   O
  070   slock  slock  slock  slock  slock  slock  slock  slock   O
  071   fkey49 '7'    '7'    '7'    '7'    '7'    '7'    '7'     N
  072   fkey50 '8'    '8'    '8'    '8'    '8'    '8'    '8'     N
  073   fkey51 '9'    '9'    '9'    '9'    '9'    '9'    '9'     N
  074   fkey52 '-'    '-'    '-'    '-'    '-'    '-'    '-'     N
  075   fkey53 '4'    '4'    '4'    '4'    '4'    '4'    '4'     N
  076   fkey54 '5'    '5'    '5'    '5'    '5'    '5'    '5'     N
  077   fkey55 '6'    '6'    '6'    '6'    '6'    '6'    '6'     N
  078   fkey56 '+'    '+'    '+'    '+'    '+'    '+'    '+'     N
  079   fkey57 '1'    '1'    '1'    '1'    '1'    '1'    '1'     N
  080   fkey58 '2'    '2'    '2'    '2'    '2'    '2'    '2'     N
  081   fkey59 '3'    '3'    '3'    '3'    '3'    '3'    '3'     N
  082   fkey60 '0'    '0'    '0'    '0'    '0'    '0'    '0'     N
  083   del    '.'    '.'    '.'    '.'    '.'    boot   boot    N
  084   nop    nop    nop    nop    nop    nop    nop    nop     O
  085   nop    nop    nop    nop    nop    nop    nop    nop     O
  086   nop    nop    nop    nop    nop    nop    nop    nop     O
  087   fkey11 fkey23 scr11  fkey47 scr11  scr11  scr11  scr11   O
  088   fkey12 fkey24 scr12  fkey48 scr12  scr12  scr12  scr12   O
  089   cr     cr     nl     nl     cr     cr     nl     nl      O
  090   rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl   O
  091   '/'    '/'    '/'    '/'    '/'    '/'    '/'    '/'     N
  092   rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl   O
  093   ralt   ralt   ralt   ralt   ralt   ralt   ralt   ralt    O
  094   fkey49 fkey49 fkey49 fkey49 fkey49 fkey49 fkey49 fkey49  O
  095   fkey50 fkey50 slock  fkey50 slock  fkey50 fkey50 fkey50  O
  096   fkey51 fkey51 fkey51 fkey51 fkey51 fkey51 fkey51 fkey51  O
  097   fkey53 fkey53 pscr   fkey53 pscr   fkey53 fkey53 fkey53  O
  098   fkey55 fkey55 nscr   fkey55 nscr   fkey55 fkey55 fkey55  O
  099   fkey57 fkey57 fkey57 fkey57 fkey57 fkey57 fkey57 fkey57  O
  100   fkey58 fkey58 slock  fkey58 slock  fkey58 fkey58 fkey58  O
  101   fkey59 fkey59 fkey59 fkey59 fkey59 fkey59 fkey59 fkey59  O
  102   fkey60 paste  fkey60 fkey60 fkey60 fkey60 fkey60 fkey60  O
  103   fkey61 fkey61 fkey61 fkey61 fkey61 fkey61 boot   fkey61  O
  104   slock  saver  slock  saver  susp   nop    susp   nop     O
  105   lalt   lalt   lalt   lalt   lalt   lalt   lalt   lalt    O
  106   lalt   lalt   lalt   lalt   lalt   lalt   lalt   lalt    O
  107   fkey64 fkey64 fkey64 fkey64 fkey64 fkey64 fkey64 fkey64  O
  108   nop    nop    nop    nop    nop    nop    nop    nop     O
  113   lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl   O
  114   lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl   O
  115   '`'    '~'    nop    nop    '`'    '~'    nop    nop     O
  125   bs     bs     del    del    bs     bs     del    del     O
#+end_src
** US EMACS MACBOOK

+ ESC <=> CapsLock
+ CMD => CTRL
+ RALT => LALT
+ Del CTRL-ALT-Space => Suspend
+ Del CTRL-ALT-ESC => Debug
+ Add CTRL-ALT-CapsLock => Suspend
+ CTRL+F{1..12} => Switch to TTY{1..12}
+ CTRL+Left/Right => Previous/Next TTY
+ CTRL+Up/Down => ScrollLock

#+begin_src conf :tangle /sudo::/usr/share/vt/keymaps/us.emacs.macbook.kbd :tangle-mode o444
  #                                                         alt
  # scan                       cntrl          alt    alt   cntrl lock
  # code  base   shift  cntrl  shift  alt    shift  cntrl  shift state
  # ------------------------------------------------------------------
    000   nop    nop    nop    nop    nop    nop    nop    nop     O
    001   clock  clock  clock  clock  clock  clock  susp  clock   O
    002   '1'    '!'    nop    nop    '1'    '!'    nop    nop     O
    003   '2'    '@'    nul    nul    '2'    '@'    nul    nul     O
    004   '3'    '#'    nop    nop    '3'    '#'    nop    nop     O
    005   '4'    '$'    nop    nop    '4'    '$'    nop    nop     O
    006   '5'    '%'    nop    nop    '5'    '%'    nop    nop     O
    007   '6'    '^'    rs     rs     '6'    '^'    rs     rs      O
    008   '7'    '&'    nop    nop    '7'    '&'    nop    nop     O
    009   '8'    '*'    nop    nop    '8'    '*'    nop    nop     O
    010   '9'    '('    nop    nop    '9'    '('    nop    nop     O
    011   '0'    ')'    nop    nop    '0'    ')'    nop    nop     O
    012   '-'    '_'    us     us     '-'    '_'    us     us      O
    013   '='    '+'    nop    nop    '='    '+'    nop    nop     O
    014   bs     bs     del    del    bs     bs     del    del     O
    015   ht     btab   nop    nop    ht     btab   nop    nop     O
    016   'q'    'Q'    dc1    dc1    'q'    'Q'    dc1    dc1     C
    017   'w'    'W'    etb    etb    'w'    'W'    etb    etb     C
    018   'e'    'E'    enq    enq    'e'    'E'    enq    enq     C
    019   'r'    'R'    dc2    dc2    'r'    'R'    dc2    dc2     C
    020   't'    'T'    dc4    dc4    't'    'T'    dc4    dc4     C
    021   'y'    'Y'    em     em     'y'    'Y'    em     em      C
    022   'u'    'U'    nak    nak    'u'    'U'    nak    nak     C
    023   'i'    'I'    ht     ht     'i'    'I'    ht     ht      C
    024   'o'    'O'    si     si     'o'    'O'    si     si      C
    025   'p'    'P'    dle    dle    'p'    'P'    dle    dle     C
    026   '['    '{'    esc    esc    '['    '{'    esc    esc     O
    027   ']'    '}'    gs     gs     ']'    '}'    gs     gs      O
    028   cr     cr     nl     nl     cr     cr     nl     nl      O
    029   lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl   O
    030   'a'    'A'    soh    soh    'a'    'A'    soh    soh     C
    031   's'    'S'    dc3    dc3    's'    'S'    dc3    dc3     C
    032   'd'    'D'    eot    eot    'd'    'D'    eot    eot     C
    033   'f'    'F'    ack    ack    'f'    'F'    ack    ack     C
    034   'g'    'G'    bel    bel    'g'    'G'    bel    bel     C
    035   'h'    'H'    bs     bs     'h'    'H'    bs     bs      C
    036   'j'    'J'    nl     nl     'j'    'J'    nl     nl      C
    037   'k'    'K'    vt     vt     'k'    'K'    vt     vt      C
    038   'l'    'L'    ff     ff     'l'    'L'    ff     ff      C
    039   ';'    ':'    nop    nop    ';'    ':'    nop    nop     O
    040   '''    '"'    nop    nop    '''    '"'    nop    nop     O
    041   '`'    '~'    nop    nop    '`'    '~'    nop    nop     O
    042   lshift lshift lshift lshift lshift lshift lshift lshift  O
    043   '\'    '|'    fs     fs     '\'    '|'    fs     fs      O
    044   'z'    'Z'    sub    sub    'z'    'Z'    sub    sub     C
    045   'x'    'X'    can    can    'x'    'X'    can    can     C
    046   'c'    'C'    etx    etx    'c'    'C'    etx    etx     C
    047   'v'    'V'    syn    syn    'v'    'V'    syn    syn     C
    048   'b'    'B'    stx    stx    'b'    'B'    stx    stx     C
    049   'n'    'N'    so     so     'n'    'N'    so     so      C
    050   'm'    'M'    cr     cr     'm'    'M'    cr     cr      C
    051   ','    '<'    nop    nop    ','    '<'    nop    nop     O
    052   '.'    '>'    nop    nop    '.'    '>'    nop    nop     O
    053   '/'    '?'    nop    nop    '/'    '?'    nop    nop     O
    054   rshift rshift rshift rshift rshift rshift rshift rshift  O
    055   '*'    '*'    '*'    '*'    '*'    '*'    '*'    '*'     O
    056   lalt   lalt   lalt   lalt   lalt   lalt   lalt   lalt    O
    057   ' '    ' '    nul    nul    ' '    ' '    nul    nul     O
    058   esc    esc    esc    esc    esc    esc    esc    esc     O
    059   fkey01 fkey13 scr01  fkey37 scr01  scr11  scr01  scr11   O
    060   fkey02 fkey14 scr02  fkey38 scr02  scr12  scr02  scr12   O
    061   fkey03 fkey15 scr03  fkey39 scr03  scr13  scr03  scr13   O
    062   fkey04 fkey16 scr04  fkey40 scr04  scr14  scr04  scr14   O
    063   fkey05 fkey17 scr05  fkey41 scr05  scr15  scr05  scr15   O
    064   fkey06 fkey18 scr06  fkey42 scr06  scr16  scr06  scr16   O
    065   fkey07 fkey19 scr07  fkey43 scr07  scr07  scr07  scr07   O
    066   fkey08 fkey20 scr08  fkey44 scr08  scr08  scr08  scr08   O
    067   fkey09 fkey21 scr09  fkey45 scr09  scr09  scr09  scr09   O
    068   fkey10 fkey22 scr10  fkey46 scr10  scr10  scr10  scr10   O
    069   nlock  nlock  nlock  nlock  nlock  nlock  nlock  nlock   O
    070   slock  slock  slock  slock  slock  slock  slock  slock   O
    071   fkey49 '7'    '7'    '7'    '7'    '7'    '7'    '7'     N
    072   fkey50 '8'    '8'    '8'    '8'    '8'    '8'    '8'     N
    073   fkey51 '9'    '9'    '9'    '9'    '9'    '9'    '9'     N
    074   fkey52 '-'    '-'    '-'    '-'    '-'    '-'    '-'     N
    075   fkey53 '4'    '4'    '4'    '4'    '4'    '4'    '4'     N
    076   fkey54 '5'    '5'    '5'    '5'    '5'    '5'    '5'     N
    077   fkey55 '6'    '6'    '6'    '6'    '6'    '6'    '6'     N
    078   fkey56 '+'    '+'    '+'    '+'    '+'    '+'    '+'     N
    079   fkey57 '1'    '1'    '1'    '1'    '1'    '1'    '1'     N
    080   fkey58 '2'    '2'    '2'    '2'    '2'    '2'    '2'     N
    081   fkey59 '3'    '3'    '3'    '3'    '3'    '3'    '3'     N
    082   fkey60 '0'    '0'    '0'    '0'    '0'    '0'    '0'     N
    083   del    '.'    '.'    '.'    '.'    '.'    boot   boot    N
    084   nop    nop    nop    nop    nop    nop    nop    nop     O
    085   nop    nop    nop    nop    nop    nop    nop    nop     O
    086   '`'    '~'    nop    nop    '`'    '~'    nop    nop     O
    087   fkey11 fkey23 scr11  fkey47 scr11  scr11  scr11  scr11   O
    088   fkey12 fkey24 scr12  fkey48 scr12  scr12  scr12  scr12   O
    089   cr     cr     nl     nl     cr     cr     nl     nl      O
    090   rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl   O
    091   '/'    '/'    '/'    '/'    '/'    '/'    '/'    '/'     N
    092   nscr   pscr   debug  debug  nop    nop    nop    nop     O
    093   lalt   lalt   lalt   lalt   lalt   lalt   lalt   lalt    O
    094   fkey49 fkey49 fkey49 fkey49 fkey49 fkey49 fkey49 fkey49  O
    095   fkey50 fkey50 slock  fkey50 slock  fkey50 fkey50 fkey50  O
    096   fkey51 fkey51 fkey51 fkey51 fkey51 fkey51 fkey51 fkey51  O
    097   fkey53 fkey53 pscr   fkey53 pscr   fkey53 fkey53 fkey53  O
    098   fkey55 fkey55 nscr   fkey55 nscr   fkey55 fkey55 fkey55  O
    099   fkey57 fkey57 fkey57 fkey57 fkey57 fkey57 fkey57 fkey57  O
    100   fkey58 fkey58 slock  fkey58 slock  fkey58 fkey58 fkey58  O
    101   fkey59 fkey59 fkey59 fkey59 fkey59 fkey59 fkey59 fkey59  O
    102   fkey60 paste  fkey60 fkey60 fkey60 fkey60 fkey60 fkey60  O
    103   fkey61 fkey61 fkey61 fkey61 fkey61 fkey61 boot   fkey61  O
    104   slock  saver  slock  saver  susp   nop    susp   nop     O
    105   lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl   O
    106   rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl  rctrl   O
    107   fkey64 fkey64 fkey64 fkey64 fkey64 fkey64 fkey64 fkey64  O
    108   nop    nop    nop    nop    nop    nop    nop    nop     O

#+end_src
* XORG

On FreeBSD Xorg configuration lives in =/usr/local/etc/X11/xorg.conf.d/= so
add: =:tangle /sudo::/usr/local/etc/X11/xorg.conf.d/20-foo.conf= to the block
declarations if you so wish. However, for now I'm setting all of these to
== whilst I figure things out...

** INTEL

#+begin_src conf :tangle /sudo::/usr/local/share/X11/xorg.conf.d/20-intel.conf
  Section "Device"
  	Identifier "Card0"
  	Driver     "intel"
  EndSection
#+end_src

** RADEON

#+begin_src conf
  Section "Device"
  	Identifier "Card0"
  	Driver     "radeon"
  EndSection
#+end_src

** DPMS

#+begin_src conf :tangle /sudo::/usr/local/share/X11/xorg.conf.d/10-serverflags.conf
  Section "ServerFlags"
  	Option "StandbyTime" "5"
  	Option "SuspendTime" "10"
  	Option "OffTime"     "15"
  EndSection
#+end_src

** MULTIPLE GPU

#+begin_src conf
  Section "Device"
  	Identifier "Card0"
  	Driver     "intel"
  	BusID      "pci0:0:2:0"
  EndSection

  Section "Device"
  	Identifier "Card1"
  	Driver     "radeon"
  	BusID      "pci0:1:0:0"
  EndSection
#+end_src

** KEYBOARD

This code might need to go in =/usr/local/share/X11/xorg.conf.d= instead of
=/usr/local/etc/X11/xorg.conf.d/= for the settings to persist across
suspend/resume...

*** MACBOOK STANDARD

#+begin_src conf
  Section "InputClass"
  	  Identifier "libinput keyboard catchall"
  	  MatchIsKeyboard "on"
  	  MatchDevicePath "/dev/input/event*"
  	  Driver "libinput"
  	  Option "XkbLayout" "us"
  	  Option "XkbOptions" "caps:swapescape,ctrl:swap_lwin_lctl,ctrl:swap_rwin_rctl"
  	  Option "AutoRepeat" "200 50"
  EndSection
#+end_src

*** MACBOOK KOREAN/JAPANESE
**** EXTRA XKB OPTIONS
#+begin_src conf :tangle /sudo::/usr/local/share/X11/xkb/symbols/hangul
// Make better use of a Korean keyboard with a non-Korean layout

// Hangul and Hangul_Hanja keys -> Control
partial modifier_keys
xkb_symbols "ctrl" {
    replace key <HNGL> { [ Control_L ], type[group1] = "ONE_LEVEL" };
    replace key <HJCV> { [ Control_L ], type[group1] = "ONE_LEVEL" };
    modifier_map Control { <HNGL>, <HJCV> };
};

// Dead key to the right of left Shift -> Grave/Tilde
// Dead key to the right of BackSpace -> BackSpace
partial alphanumeric_keys
xkb_symbols "deadkeys" {
   key <AB11> { [ grave, asciitilde ] };
   key <AE13> { [ BackSpace, Delete ] };
};
#+end_src
#+begin_src conf :tangle /sudo::/usr/local/share/X11/xkb/symbols/leftmods
// Japanese/Korean MacBook (Non-Standard?) Far Left Modifier Options
partial modifier_keys
xkb_symbols "caps_esc_altgr" {
    key <ESC>  { [ Caps_Lock ] };
    key <LCTL> { [ Escape ], type[group1] = "ONE_LEVEL" };
    key <CAPS> { [ ISO_Level3_Shift ], type[group1] = "ONE_LEVEL" };
};

partial modifier_keys
xkb_symbols "caps_esc_hyper" {
    key <ESC>  { [ Caps_Lock ] };
    key <LCTL> { [ Escape ], type[group1] = "ONE_LEVEL" };
    key <CAPS> { [ Hyper_L ], type[group1] = "ONE_LEVEL" };
};

partial modifier_keys
xkb_symbols "caps_esc_menu" {
    key <ESC>  { [ Caps_Lock ] };
    key <LCTL> { [ Escape ], type[group1] = "ONE_LEVEL" };
    key <CAPS> { [ Menu ], type[group1] = "ONE_LEVEL" };
};
#+end_src
**** EVDEV CONFIGURATION
#+name: /usr/local/share/X11/xorg.conf.d/20-evdev.conf
#+begin_src conf
Section "InputClass"
	Identifier		"Evdev keyboard"
	MatchDevicePath		"/dev/input/event*"
	MatchIsKeyboard		"on"
	Option			"XkbRules" "evdev"
	Option			"XkbLayout" "us+hangul(ctrl)+hangul(deadkeys)+leftmods(caps_esc_hyper)"
	Option			"XkbOptions" "altwin:swap_alt_win,terminate:ctrl_alt_bksp"
        Option "AutoRepeat" "200 50"
EndSection
#+end_src
** TOUCHPAD

#+begin_src conf
  Section "InputClass"
	  Identifier "libinput touchpad catchall"
	  MatchIsTouchpad "on"
	  MatchDevicePath "/dev/input/event*"
	  Driver "libinput"
	  Option "Tapping" "True"
	  Option "DisableWhileTyping" "True"
  EndSection
#+end_src

** XSESSION
#+NAME: xsession
#+BEGIN_SRC conf :tangle ~/.xsession
  pixelclock &
  pixelbatt &
  sct 4000
  exec cwm
#+END_SRC
#+BEGIN_SRC conf :noweb yes :tangle ~/.xinitrc
  <<xsession>>
#+END_SRC
** XDEFAULTS
#+NAME: xdefaults
#+begin_src conf :tangle ~/.Xdefaults
  XTerm*faceName: monospace:size=13
  XTerm*metaSendsEscape: true
  XTerm*reverseVideo: true
  XTerm*selectToClipboard: true
#+end_src
#+BEGIN_SRC conf :noweb yes :tangle ~/.Xresources
  <<xdefaults>>
#+END_SRC
** RATPOISON
#+begin_src conf :tangle ~/.ratpoisonrc
  exec xscreensaver --no-splash
  exec xbattbar left
  exec sleep 1 && sct 4000
  exec sleep 4 && alttab -mk Alt_R -frame green -inact purple

  set barpadding 0 0
  set bgcolor black
  set fgcolor purple
  set font "monospace:bold:size=12"
  set framesels "asdfjkl;"
  set fwcolor green
  set bwcolor purple
  set historysize 42
  set padding 2 0 0 0

  bind e exec xterm -e emacsclient -nw -c -a ""
  bind C-e exec emacsclient -c -a ""
  bind E exec xterm -e emacs
  bind C-E exec emacs
  bind C-q only
  bind q only
  bind C-space colon
  bind space exec
  bind C-v hsplit
  bind v hsplit
  bind w exec librewolf
  bind Tab select
  bind Return focuslast
  bind M-q quit
  bind M-r exec restart

  definekey top s-j focusdown
  definekey top s-k focusup
  definekey top s-h focusleft
  definekey top s-l focusright
  definekey top s-Return focuslast
  definekey top C-s-j exchangedown
  definekey top C-s-k exchangeup
  definekey top C-s-h exchangeleft
  definekey top C-s-l exchangeright
  definekey top F10 exec mixer vol.mute=toggle
  definekey top F11 exec mixer vol.volume=-5%
  definekey top F12 exec mixer vol.volume=+5%
#+end_src
** CWM
#+BEGIN_SRC conf :tangle ~/.cwmrc
  borderwidth 0
  gap 0 0 0 0
  sticky yes
  snapdist 5
  moveamount 5
  ignore xclock
  fontname "monospace:bold:size=18"

  color activeborder '#B28'
  color inactiveborder '#627'
  color urgencyborder '#FF0'
  color menubg '#000'
  color menufg '#627'
  color font '#DDD'
  color selfont '#FFF'
  color font '#B28'

  unbind-key all
  bind-key 4-BackSpace restart
  bind-key 4C-BackSpace quit
  bind-key 4-Return 'emacsclient -c -a ""'
  bind-key 4M-Return 'xterm'
  bind-key 4C-Return 'librewolf'
  bind-key 4-space menu-exec
  bind-key CS-w menu-window
  bind-key M-Tab window-cycle
  bind-key MS-Tab window-rcycle
  bind-key CS-q window-delete
  bind-key 4-m window-maximize
  bind-key CS-v window-vmaximize
  bind-key CS-h window-hmaximize
  bind-key 4C-m window-fullscreen
  bind-key 4-k window-move-up-big
  bind-key 4-j window-move-down-big
  bind-key 4-l window-move-right-big
  bind-key 4-h window-move-left-big
  bind-key 4C-k window-resize-up-big
  bind-key 4C-j window-resize-down-big
  bind-key 4C-l window-resize-right-big
  bind-key 4C-h window-resize-left-big
  bind-key XF86MonBrightnessDown 'sudo backlight - 10'
  bind-key XF86MonBrightnessUp 'sudo backlight + 10'
  bind-key XF86AudioMute 'mixer vol.mute=toggle'
  bind-key XF86AudioLowerVolume 'mixer vol.volume=-5%'
  bind-key XF86AudioRaiseVolume 'mixer vol.volume=+5%'

  unbind-mouse all
  bind-mouse R-1 menu-window
  bind-mouse M-1 window-move
  bind-mouse MS-1 window-resize
#+END_SRC
** GTK
#+NAME: gtk2
#+BEGIN_SRC conf :tangle ~/.gtkrc-2.0.mine
  gtk-key-theme-name = "Emacs"
#+END_SRC

#+BEGIN_SRC conf :noweb yes :tangle ~/.gtkrc-2.0
  <<gtk2>>
#+END_SRC

#+NAME: gtk3
#+BEGIN_SRC conf :tangle ~/.config/gtk-3.0/settings.ini
  [Settings]
  gtk-key-theme-name = Emacs
#+END_SRC
